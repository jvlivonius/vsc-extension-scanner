# v5.0.2 Test Quality & Documentation Roadmap

**Status:** ðŸš§ In Progress
**Type:** Patch Release - Test Quality Improvements
**Estimated Effort:** ~3-4 hours
**Impact:** +47 tests, better test organization, current documentation

---

## Executive Summary

Improve test suite quality through parametrization and property-based testing while updating documentation to reflect v5.0.0 and v5.0.1 releases. Focus on quick wins with high value for patch release.

### Goals

1. **Test Quality**: Increase parametrized tests from 4.6% â†’ 15%
2. **Property Testing**: Expand from 2 â†’ 4-5 property test files
3. **Documentation**: Update STATUS.md (currently 2 versions behind)
4. **Test Cleanup**: Integrate pending test improvements (+12 security tests)

### Outcomes

- âœ… Test count: 1,153 â†’ ~1,200 (+47 via parametrization & properties)
- âœ… Parametrized files: 3 â†’ 10 (4.6% â†’ 15.4%)
- âœ… Property test files: 2 â†’ 4-5
- âœ… Documentation current (STATUS.md, CHANGELOG.md)
- âœ… No breaking changes

---

## Context: Test Suite Analysis Findings

From comprehensive test suite analysis (2025-11-08):

### Current State
- **Total Tests:** 1,153
- **Test Files:** 65
- **Coverage:** 89%+
- **Parametrized Tests:** 4.6% (only 3 files)
- **Property Tests:** 2 files (Hypothesis)
- **Overall Grade:** A- (87/100)

### Improvement Opportunities
1. **Parametrization:** Only 4.6% vs target 20%
2. **Property Testing:** Only 2 files vs target 6-8 files
3. **Fixtures:** Only 3.1% using shared fixtures

### Test Distribution
```
Unit Tests          825 (71.5%)
Security Tests      235 (20.4%)
Parallel Tests       41 ( 3.6%)
Mock Validation      31 ( 2.7%)
Integration Tests     6 ( 0.5%)
```

---

## Phase 0: Pending Changes Integration

**Status:** âœ… Complete (from previous work)

### Changes Ready to Commit

1. **Test Cleanup:**
   - Deleted: `tests/test_api.py` (obsolete manual utility)
   - Deleted: `tests/test_security.py` (obsolete manual utility)
   - Added: `tests/test_security_manual_validation.py` (12 new pytest tests)

2. **Test Coverage:**
   - Security tests: 223 â†’ 235 (+12 tests)
   - Total tests: 1,141 â†’ 1,153 (+12 tests)
   - All tests passing: 1,152 passed, 1 skipped

### Benefits
- âœ… All test files now have executable pytest tests
- âœ… No more 0-test collection issues
- âœ… Better security test organization
- âœ… Proper pytest structure for CI/CD

---

## Phase 1: Documentation Updates

**Estimated Time:** 30 minutes
**Priority:** Critical

### Task 1.1: Update STATUS.md

**Current Issues:**
- Shows v4.0.0 as latest release (2 versions behind)
- Missing v5.0.0 and v5.0.1 release notes
- Test metrics outdated (1,141 â†’ 1,153)

**Updates Required:**
1. Add v5.0.0 release section:
   - Database Optimization & Schema Redesign (Schema v5.0)
   - 60% storage reduction, 30% query performance improvement
   - Eliminated denormalization anti-pattern
   - Added CHECK constraints for data integrity

2. Add v5.0.1 release section:
   - CLI cleanup and version bump
   - Parallel test execution infrastructure

3. Update current metrics:
   - Version: 4.0.0 â†’ 5.0.1
   - Schema: 4.0 â†’ 5.0
   - Total Tests: 1,125 â†’ 1,153
   - Test coverage metrics

**Acceptance Criteria:**
- [ ] v5.0.0 release documented with breaking changes
- [ ] v5.0.1 release documented
- [ ] Metrics section updated
- [ ] Version history table updated

### Task 1.2: Create v5.0.2 Roadmap

**Content:**
- Document this roadmap in `docs/project/v5.0.2-roadmap.md`
- Reference test suite analysis findings
- Link to improvement recommendations

**Acceptance Criteria:**
- [ ] Roadmap created with phases and tasks
- [ ] Test suite analysis findings referenced
- [ ] Clear success criteria defined

---

## Phase 2: Test Parametrization

**Estimated Time:** 2 hours
**Goal:** Increase parametrized tests from 4.6% â†’ 15% (7 â†’ 10 files)
**Impact:** +45-65 test cases via data-driven testing

### Rationale

**Benefits of Parametrization:**
- Eliminates repetitive test code
- Improves test readability
- Makes adding new test cases trivial
- Better test output with descriptive IDs
- Maintains single assertion per test case

**Current Underutilization:**
- Only 3 files use `@pytest.mark.parametrize`
- Heavy code duplication in validator tests
- Boundary condition tests written manually

### Task 2.1: Parametrize Input Validators

**File:** `tests/test_input_validators.py` (756 lines, 40 tests)

**Current Pattern (Repetitive):**
```python
def test_valid_extension_id_simple():
    assert validate_extension_id("ms-python.python") == True

def test_valid_extension_id_with_hyphen():
    assert validate_extension_id("ms-vscode.vscode-json") == True
```

**Improved Pattern (Parametrized):**
```python
@pytest.mark.parametrize("extension_id,expected", [
    ("ms-python.python", True),
    ("ms-vscode.vscode-json", True),
    ("GitHub.copilot", True),
    ("invalid..double-dot", False),
    ("no-dot-separator", False),
])
def test_extension_id_validation(extension_id, expected):
    assert validate_extension_id(extension_id) == expected
```

**Implementation:**
1. Identify repetitive test patterns
2. Extract test data to parameter lists
3. Convert to parametrized tests
4. Verify same coverage with fewer LOC

**Expected Results:**
- Convert ~20 repetitive tests â†’ 1 parametrized test with 20 cases
- Add 10-15 new boundary cases
- Net: +10-15 test cases, -50 LOC

**Acceptance Criteria:**
- [ ] Extension ID validation parametrized
- [ ] Publisher validation parametrized
- [ ] Version validation parametrized
- [ ] All original tests preserved as parameters
- [ ] 10+ new boundary cases added
- [ ] Tests pass with same coverage

### Task 2.2: Parametrize Path Validation

**File:** `tests/test_path_validation.py` (existing security tests)

**Target Tests:**
- System directory blocking
- Path traversal prevention
- URL encoding attacks
- Home directory allowance

**Implementation:**
```python
@pytest.mark.parametrize("path,should_raise,reason", [
    ("/etc/passwd", True, "system directory"),
    ("/var/log/auth.log", True, "system directory"),
    ("../../../etc/passwd", True, "path traversal"),
    ("%2e%2e%2f", True, "url encoding"),
    ("~/.vscode", False, "home directory allowed"),
])
def test_validate_path_security(path, should_raise, reason):
    if should_raise:
        with pytest.raises(ValueError, match=reason):
            validate_path(path)
    else:
        result = validate_path(path)
        assert result is not None
```

**Expected Results:**
- Consolidate 10-15 repetitive tests
- Add 5-10 new attack vectors
- Improve test documentation via parameter names

**Acceptance Criteria:**
- [ ] Path traversal tests parametrized
- [ ] System directory tests parametrized
- [ ] Encoding attack tests parametrized
- [ ] New attack vectors added
- [ ] Tests pass with improved coverage

### Task 2.3: Parametrize Output Formatters

**File:** `tests/test_output_formatter.py` (709 lines, 24 tests)

**Target Tests:**
- JSON formatting edge cases
- CSV delimiter handling
- Field presence validation

**Implementation:**
```python
@pytest.mark.parametrize("vulnerabilities,expected_status", [
    ({"count": 0}, "PASS"),
    ({"count": 1}, "FAIL"),
    ({"count": 5, "critical": 2}, "FAIL"),
    ({}, "UNKNOWN"),
])
def test_json_vulnerability_formatting(vulnerabilities, expected_status):
    result = format_json_output({"vulnerabilities": vulnerabilities})
    assert result["status"] == expected_status
```

**Expected Results:**
- Convert 10-12 formatting tests â†’ parametrized
- Add 5-8 new edge cases
- Better edge case documentation

**Acceptance Criteria:**
- [ ] JSON formatting parametrized
- [ ] CSV formatting parametrized
- [ ] Field validation parametrized
- [ ] New edge cases added
- [ ] Tests pass with same coverage

### Task 2.4: Parametrize Scanner Filters

**File:** `tests/test_scanner_filters.py` (1,017 lines, 45 tests)

**Target Tests:**
- Publisher filtering combinations
- Risk level filtering
- Vulnerability count filtering

**Implementation:**
```python
@pytest.mark.parametrize("filter_config,expected_count", [
    ({"publisher": "microsoft"}, 3),
    ({"risk_level": "high"}, 5),
    ({"publisher": "microsoft", "risk_level": "low"}, 1),
    ({"verified_only": True}, 10),
])
def test_filter_combinations(filter_config, expected_count, mock_extensions):
    filtered = apply_filters(mock_extensions, filter_config)
    assert len(filtered) == expected_count
```

**Expected Results:**
- Convert 8-10 filter tests â†’ parametrized
- Add 10-15 new filter combinations
- Better coverage of edge cases

**Acceptance Criteria:**
- [ ] Publisher filters parametrized
- [ ] Risk filters parametrized
- [ ] Combination filters parametrized
- [ ] New combinations added
- [ ] Tests pass with improved coverage

---

## Phase 3: Property-Based Testing Expansion

**Estimated Time:** 1 hour
**Goal:** Add 2-3 new property test files (2 â†’ 4-5 files)
**Impact:** +1,000s of auto-generated test cases

### Rationale

**Benefits of Property-Based Testing:**
- Automatically discovers edge cases
- Tests invariant properties (never crashes, always returns expected type)
- Fuzzing for security vulnerabilities
- Regression detection via saved examples

**Current State:**
- Only 2 files use Hypothesis
- Security-critical functions not fuzz-tested
- Manual edge case testing incomplete

### Task 3.1: String Sanitization Properties

**File:** `tests/test_property_sanitization.py` (NEW)

**Properties to Test:**
```python
from hypothesis import given, strategies as st

@given(st.text())
def test_sanitize_string_never_crashes(text):
    """Property: sanitize_string never crashes on any input."""
    result = sanitize_string(text)
    assert isinstance(result, str)

@given(st.text())
def test_sanitize_string_is_idempotent(text):
    """Property: sanitize(sanitize(x)) == sanitize(x)."""
    once = sanitize_string(text)
    twice = sanitize_string(once)
    assert once == twice

@given(st.text())
def test_sanitize_string_removes_ansi(text):
    """Property: Output contains no ANSI escape sequences."""
    result = sanitize_string(text)
    assert '\x1b[' not in result

@given(st.text(min_size=1))
def test_sanitize_string_preserves_length_bounds(text):
    """Property: Output length <= input length (only removes, never adds)."""
    result = sanitize_string(text)
    assert len(result) <= len(text)
```

**Implementation:**
1. Create new test file with property tests
2. Test all sanitize_string contexts (display, logging, output)
3. Add regression test examples from failures

**Expected Results:**
- 4-5 property tests Ã— 1,000 examples = 4,000-5,000 test cases
- Discover edge cases not covered by manual tests
- Better confidence in sanitization security

**Acceptance Criteria:**
- [ ] File created with 4+ property tests
- [ ] Never crashes property validated
- [ ] Idempotency property validated
- [ ] ANSI removal property validated
- [ ] Length bounds property validated
- [ ] Tests pass with 1,000+ examples each

### Task 3.2: Path Validation Properties

**File:** `tests/test_property_path_validation.py` (NEW)

**Properties to Test:**
```python
from hypothesis import given, strategies as st

# Strategies for path generation
safe_paths = st.text(alphabet="abcdefghijklmnopqrstuvwxyz0123456789-_./", min_size=1, max_size=100)
attack_paths = st.sampled_from([
    "../", "../../", "../../../",
    "%2e%2e%2f", "%252e%252e%252f",
    "/etc/", "/var/", "/root/",
])

@given(attack_paths)
def test_validate_path_blocks_all_attacks(path):
    """Property: All known attack patterns are blocked."""
    with pytest.raises(ValueError):
        validate_path(path)

@given(st.text().map(lambda x: os.path.expanduser(f"~/{x}")))
def test_validate_path_allows_home_paths(path):
    """Property: All home directory paths are allowed."""
    result = validate_path(path)
    assert result is not None

@given(safe_paths)
def test_validate_path_never_crashes(path):
    """Property: validate_path never crashes, only raises ValueError."""
    try:
        validate_path(path)
    except ValueError:
        pass  # Expected for invalid paths
```

**Expected Results:**
- 3-4 property tests Ã— 1,000 examples = 3,000-4,000 test cases
- Comprehensive attack vector coverage
- Regression prevention

**Acceptance Criteria:**
- [ ] File created with 3+ property tests
- [ ] Attack blocking property validated
- [ ] Home path allowance property validated
- [ ] Never crashes property validated
- [ ] Tests pass with 1,000+ examples each

---

## Phase 4: Commit & Release

**Estimated Time:** 30 minutes

### Task 4.1: Git Workflow

**Commits:**
1. Test cleanup (pending changes)
2. Documentation updates (STATUS.md, roadmap)
3. Test parametrization improvements
4. Property-based test additions
5. CHANGELOG.md update
6. Version bump to v5.0.2

**Branch Strategy:**
```bash
git checkout -b feature/v5.0.2-test-quality
git add tests/test_security_manual_validation.py
git rm tests/test_api.py tests/test_security.py
git commit -m "fix(tests): Convert non-executable test files to proper pytest tests

- Convert test_security.py to test_security_manual_validation.py (12 new tests)
- Delete obsolete test utilities (test_api.py, test_security.py)
- All test_*.py files now have executable tests
- Total tests: 1,141 â†’ 1,153 (+12 security tests)"

# ... additional commits for each phase ...

git push origin feature/v5.0.2-test-quality
```

**Acceptance Criteria:**
- [ ] All changes committed with clear messages
- [ ] Branch pushed to remote
- [ ] Ready for PR creation

### Task 4.2: CHANGELOG.md Update

**Content:**
```markdown
## [5.0.2] - 2025-11-08

### Added

- **Test Quality Improvements**: Increased parametrized tests from 4.6% â†’ 15%
  - Parametrized input validation tests (+20 test cases)
  - Parametrized path validation tests (+15 test cases)
  - Parametrized output formatter tests (+10 test cases)
  - Parametrized scanner filter tests (+15 test cases)

- **Property-Based Testing**: Expanded Hypothesis coverage
  - Added test_property_sanitization.py (4 properties Ã— 1,000 examples = 4,000 cases)
  - Added test_property_path_validation.py (3 properties Ã— 1,000 examples = 3,000 cases)

- **Test Cleanup**: Converted manual test utilities to proper pytest tests
  - Added test_security_manual_validation.py (12 new security tests)
  - Removed obsolete test_api.py and test_security.py utilities

### Changed

- **Documentation Updates**: STATUS.md current with v5.0.0 and v5.0.1 releases
- **Test Organization**: All test files now have executable pytest tests
- **Test Count**: 1,153 â†’ ~1,200 (+47 via parametrization & properties)

### Fixed

- Test file discovery: No more 0-test collection issues
- Test organization: Clear pytest structure for all tests
```

**Acceptance Criteria:**
- [ ] CHANGELOG.md updated with v5.0.2 section
- [ ] All changes documented
- [ ] Follows Keep a Changelog format

### Task 4.3: Version Bump

**Files to Update:**
- `vscode_scanner/_version.py`: `__version__ = "5.0.2"`
- `pyproject.toml`: `version = "5.0.2"` (if present)

**Git Tag:**
```bash
git tag -a v5.0.2 -m "Release v5.0.2: Test Quality & Documentation Update"
git push origin v5.0.2
```

**Acceptance Criteria:**
- [ ] Version bumped to 5.0.2
- [ ] Git tag created
- [ ] Tag pushed to remote

---

## Success Metrics

### Quantitative

| Metric | Before | After | Target | Status |
|--------|--------|-------|--------|--------|
| Total Tests | 1,153 | ~1,200 | 1,200 | â³ |
| Parametrized Files | 3 (4.6%) | 10 (15.4%) | 10 | â³ |
| Property Test Files | 2 | 4-5 | 4 | â³ |
| Test Quality Score | 85/100 | 90/100 | 90 | â³ |
| Documentation Currency | 2 versions behind | Current | Current | â³ |

### Qualitative

- âœ… Better test maintainability through parametrization
- âœ… Improved security testing with property-based fuzzing
- âœ… Up-to-date documentation for v5.0.x releases
- âœ… Clearer test organization and structure
- âœ… No breaking changes (patch release)

---

## Risks & Mitigation

| Risk | Impact | Mitigation |
|------|--------|------------|
| Test parametrization breaks coverage | Medium | Verify coverage before/after each file |
| Property tests find bugs | Low | Fix bugs (good outcome!) |
| Documentation becomes stale | Low | Automate STATUS.md updates in future |
| Time overrun | Low | Defer property tests to v5.1 if needed |

---

## Future Work (Deferred to v5.1+)

**Not in v5.0.2 Scope** (larger efforts):

1. **Performance Benchmarks** (v5.1)
   - Requires pytest-benchmark setup
   - Add 5-10 benchmark tests
   - Establish baseline metrics

2. **Contract Testing** (v5.1)
   - Validate vscan.dev API compatibility
   - Use Pact or similar framework
   - Ensure mock/real API consistency

3. **Snapshot Testing** (v5.1)
   - HTML report generation
   - JSON output formatting
   - Requires pytest-snapshot dependency

4. **Common Fixtures Extraction** (v5.1)
   - Extract shared test setup
   - Organize in conftest.py
   - Reduce duplication (current 3.1% â†’ target 15%)

5. **Mutation Testing** (v5.2+)
   - Use mutmut or similar
   - Verify test effectiveness
   - Target 80%+ mutation score

---

## Implementation Timeline

**Target:** Single session (~3-4 hours)

| Phase | Time | Tasks |
|-------|------|-------|
| Phase 1 | 30 min | Documentation updates |
| Phase 2 | 2 hours | Test parametrization (4 files) |
| Phase 3 | 1 hour | Property-based tests (2 files) |
| Phase 4 | 30 min | Commit & release |

**Total:** 4 hours

---

## References

- **Test Suite Analysis:** 2025-11-08 comprehensive analysis
- **v5.0.0 Release:** Database Optimization & Schema Redesign
- **v5.0.1 Release:** CLI Cleanup & Version Bump
- **Test Quality Metrics:** A- (87/100) baseline
- **Improvement Recommendations:** From test suite analysis report

---

## Approval & Sign-off

**Status:** ðŸ“‹ Planning â†’ ðŸš§ In Progress
**Start Date:** 2025-11-08
**Target Completion:** 2025-11-08
**Assigned:** Development Team
**Reviewed:** â³ Pending
**Approved:** â³ Pending

---

*This roadmap follows the project's standard roadmap template and aligns with semantic versioning (patch release = bug fixes & improvements, no breaking changes).*
