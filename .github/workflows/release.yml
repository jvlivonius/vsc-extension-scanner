name: Build & Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags: v1.0.0, v2.1.3, etc.

# Restrict permissions to minimum required
permissions:
  contents: write  # Required for creating releases and uploading artifacts

jobs:
  build-and-release:
    name: Build Distribution & Create Release
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog extraction

      - name: Extract version from tag
        id: version
        run: |
          # Extract version number from tag (v1.2.3 -> 1.2.3)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Building version: $VERSION"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install build dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install --upgrade build

      - name: Run smoke tests on source
        run: |
          echo "ðŸ§ª Running critical smoke tests on source code..."

          # Install test dependencies
          pip install "pytest>=7.0.0" "hypothesis>=6.0.0" "pyyaml>=6.0.0"
          if [ $(python3 -c "import sys; print(1 if sys.version_info < (3, 11) else 0)") -eq 1 ]; then
            pip install "tomli>=2.0.0"
          fi

          # Run security tests (critical validation)
          echo "Running security tests..."
          python3 tests/test_security.py || { echo "âŒ Security smoke test failed"; exit 1; }

          # Run architecture tests (zero violations check)
          echo "Running architecture tests..."
          pytest tests/test_architecture.py -xvs || { echo "âŒ Architecture smoke test failed"; exit 1; }

          echo "âœ… All smoke tests passed"

      - name: Clean build environment
        run: |
          echo "ðŸ§¹ Cleaning previous build artifacts..."
          rm -rf build/ dist/ *.egg-info
          echo "âœ… Build environment clean"

      - name: Build distribution packages
        run: |
          echo "ðŸ”¨ Building wheel and source distribution..."
          python3 -m build
          echo "âœ… Build complete"
          echo ""
          echo "ðŸ“¦ Distribution packages:"
          ls -lh dist/

      - name: Generate checksums
        run: |
          echo "ðŸ” Generating SHA256 checksums..."
          cd dist/
          shasum -a 256 *.whl *.tar.gz > SHA256SUMS.txt
          echo "âœ… Checksums generated"
          echo ""
          cat SHA256SUMS.txt
          cd ..

      - name: Verify package installation
        run: |
          echo "ðŸ§ª Testing package installation in isolated environment..."

          # Create test environment
          python3 -m venv test-release-env
          source test-release-env/bin/activate

          # Install from wheel
          WHEEL_FILE=$(ls dist/*.whl)
          pip install "$WHEEL_FILE"

          # Verify version matches tag
          INSTALLED_VERSION=$(vscan --version 2>&1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' || echo "unknown")
          EXPECTED_VERSION="${{ steps.version.outputs.version }}"

          echo "Expected version: $EXPECTED_VERSION"
          echo "Installed version: $INSTALLED_VERSION"

          if [ "$INSTALLED_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "âŒ Version mismatch!"
            exit 1
          fi

          # Verify basic commands work
          echo "Testing basic commands..."
          vscan --help > /dev/null || { echo "âŒ vscan --help failed"; exit 1; }
          vscan cache stats > /dev/null || true  # May fail if no cache exists, that's ok

          # Verify Python import
          python3 -c "import vscode_scanner; print(f'âœ… Import successful: {vscode_scanner.__version__}')" || { echo "âŒ Import failed"; exit 1; }

          echo "âœ… Package installation verified"

          # Cleanup
          deactivate
          rm -rf test-release-env

          echo "âœ… Package verification complete"

      - name: Extract release notes
        id: release_notes
        run: |
          echo "ðŸ“ Extracting release notes..."

          VERSION="${{ steps.version.outputs.version }}"
          RELEASE_NOTES_FILE="docs/archive/summaries/v${VERSION}-release-notes.md"

          # Prefer release notes file if it exists
          if [ -f "$RELEASE_NOTES_FILE" ]; then
            echo "âœ… Using comprehensive release notes from $RELEASE_NOTES_FILE"
            cat "$RELEASE_NOTES_FILE" > release-notes.txt
          elif [ -f "CHANGELOG.md" ]; then
            echo "âš ï¸ Release notes file not found, extracting from CHANGELOG.md"
            # Fallback: Extract from CHANGELOG
            NOTES=$(awk "
              /^## \[$VERSION\]/ { found=1; next }
              found && /^## \[/ { exit }
              found { print }
            " CHANGELOG.md)

            if [ -n "$NOTES" ]; then
              echo "âœ… Extracted from CHANGELOG.md"
              echo "$NOTES" > release-notes.txt
            else
              echo "âš ï¸ No release notes found for version $VERSION"
              echo "Release v$VERSION" > release-notes.txt
            fi
          else
            echo "âš ï¸ No release notes or CHANGELOG.md found"
            echo "Release v$VERSION" > release-notes.txt
          fi

          echo "ðŸ“„ Release notes preview (first 10 lines):"
          head -10 release-notes.txt

      - name: Create GitHub Release
        run: |
          echo "ðŸš€ Creating GitHub release v${{ steps.version.outputs.version }}..."

          # Create release using GitHub CLI
          gh release create v${{ steps.version.outputs.version }} \
            dist/*.whl \
            dist/*.tar.gz \
            dist/SHA256SUMS.txt \
            --title "v${{ steps.version.outputs.version }}" \
            --notes-file release-notes.txt \
            --verify-tag

          echo "âœ… GitHub release created successfully"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "# ðŸŽ‰ Release Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Distribution Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh dist/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ” Checksums" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat dist/SHA256SUMS.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… GitHub Release created with artifacts" >> $GITHUB_STEP_SUMMARY
