# Security Workflow for VS Code Extension Security Scanner
# Comprehensive security scanning on every commit and weekly schedule
#
# Tools Integrated (Phase 1):
# - Bandit: AST-based Python security scanning
# - Safety: Dependency vulnerability scanning
# - pip-audit: PyPI package auditing
# - Security Tests: Custom SQLite and validation tests
#
# Triggers:
# - Push to main/master/develop branches
# - Push to claude/** branches (Claude Code branches)
# - Pull requests to main/master/develop
# - Weekly schedule (Monday 00:00 UTC)

name: Security Checks

on:
  push:
    branches:
      - main
      - master
      - develop
      - 'claude/**'
  pull_request:
    branches:
      - main
      - master
      - develop
  schedule:
    # Weekly security scan every Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:  # Allow manual triggering

# Cancel in-progress runs when new push occurs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Restrict permissions to minimum required
permissions:
  contents: read
  security-events: write

jobs:
  security-scan:
    name: Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install package and dependencies
        run: |
          pip install --upgrade pip
          pip install -e .[test]
          pip install bandit safety pip-audit bandit-sarif-formatter

      - name: Bandit Security Scanner (High Severity - Blocking)
        id: bandit-high
        run: |
          echo "Running Bandit for HIGH severity issues (blocking)..."
          bandit -r vscode_scanner/ -lll
          echo "✅ No high-severity security issues found"

      - name: Bandit Security Scanner (Medium Severity - Informational)
        id: bandit-medium
        continue-on-error: true
        run: |
          echo "Running Bandit for MEDIUM severity issues (informational)..."
          bandit -r vscode_scanner/ -ll -f json -o bandit-report.json
          echo "Bandit report (terminal output):"
          bandit -r vscode_scanner/ -ll
          echo "✅ Bandit medium-severity scan complete"

      - name: Bandit SARIF Report
        id: bandit-sarif
        if: always()
        continue-on-error: true
        run: |
          echo "Generating SARIF report for GitHub Security tab..."
          # Generate SARIF report using Microsoft's bandit-sarif-formatter plugin
          bandit --format sarif -r vscode_scanner/ -ll -o bandit-report.sarif || true
          echo "✅ SARIF report generated"

      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: bandit-report.sarif
          category: bandit

      - name: Safety Dependency Check
        id: safety
        continue-on-error: true
        run: |
          echo "Running Safety dependency vulnerability scanner..."
          pip freeze > requirements-scan.txt
          safety check --file requirements-scan.txt --full-report --output text
          echo "✅ Safety scan complete"

      - name: pip-audit Package Audit
        id: pip-audit
        continue-on-error: true
        run: |
          echo "Running pip-audit PyPI package auditing..."
          pip-audit --desc
          echo "✅ pip-audit complete"

      - name: Security Scanner Summary
        if: always()
        run: |
          echo ""
          echo "=================================================="
          echo "Security Scanner Summary"
          echo "=================================================="
          echo ""
          echo "Bandit (High): ${{ steps.bandit-high.outcome }}"
          echo "Bandit (Med):  ${{ steps.bandit-medium.outcome }}"
          echo "Safety:        ${{ steps.safety.outcome }}"
          echo "pip-audit:     ${{ steps.pip-audit.outcome }}"
          echo ""

          # Warn if scanners found issues
          if [ "${{ steps.bandit-high.outcome }}" == "failure" ]; then
            echo "❌  Bandit found HIGH severity issues (build blocked)"
          fi
          if [ "${{ steps.bandit-medium.outcome }}" == "failure" ]; then
            echo "⚠️  Bandit found medium severity issues (review bandit-report.json)"
          fi
          if [ "${{ steps.safety.outcome }}" == "failure" ]; then
            echo "⚠️  Safety found dependency vulnerabilities"
          fi
          if [ "${{ steps.pip-audit.outcome }}" == "failure" ]; then
            echo "⚠️  pip-audit found package vulnerabilities"
          fi

          echo ""
          echo "✅ Security scanner analysis complete"
          echo "Note: Security test validation runs in Tests workflow"

      - name: Upload Security Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
            bandit-report.sarif
            requirements-scan.txt
          retention-days: 90

      - name: Upload Security Report (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: security-failure-report
          path: |
            bandit-report.json
            bandit-report.sarif
            requirements-scan.txt
          retention-days: 30

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: security-scan
    if: always()

    steps:
      - name: Generate Security Summary
        run: |
          echo "# Security Scanner Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.security-scan.result }}" == "success" ]; then
            echo "✅ **Security scanner analysis complete**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All security scanners executed successfully:" >> $GITHUB_STEP_SUMMARY
            echo "- Bandit AST security analysis" >> $GITHUB_STEP_SUMMARY
            echo "- Safety dependency scanning" >> $GITHUB_STEP_SUMMARY
            echo "- pip-audit package auditing" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Note:** Security test validation runs in Tests workflow" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Security scanner failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Review the security scan job for details." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Tools Used" >> $GITHUB_STEP_SUMMARY
          echo "- **Bandit**: AST-based Python security scanner" >> $GITHUB_STEP_SUMMARY
          echo "- **Safety**: Dependency vulnerability database (50K+ CVEs)" >> $GITHUB_STEP_SUMMARY
          echo "- **pip-audit**: Official PyPA package auditing tool" >> $GITHUB_STEP_SUMMARY
