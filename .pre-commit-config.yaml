# Pre-commit hooks for VS Code Extension Security Scanner
# Prevents security issues and enforces code quality before commits
#
# Installation:
#   pip install pre-commit
#   pre-commit install
#
# Run manually:
#   pre-commit run --all-files

repos:
  # Standard pre-commit hooks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
        name: Trim trailing whitespace
      - id: end-of-file-fixer
        name: Fix end of files
      - id: check-yaml
        name: Check YAML syntax
      - id: check-json
        name: Check JSON syntax
      - id: check-added-large-files
        name: Check for large files
        args: ['--maxkb=500']
      - id: check-merge-conflict
        name: Check for merge conflicts
      - id: detect-private-key
        name: Detect private keys
      - id: check-case-conflict
        name: Check for case conflicts
      - id: mixed-line-ending
        name: Check mixed line endings
        args: ['--fix=lf']

  # Black code formatter
  - repo: https://github.com/psf/black
    rev: 23.12.1
    hooks:
      - id: black
        name: Black code formatting
        language_version: python3
        args: ['--line-length=88']

  # Bandit security scanner
  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.6
    hooks:
      - id: bandit
        name: Bandit security scan
        args: ['-ll', '-r', 'vscode_scanner/']
        exclude: ^tests/

  # Pylint with security plugin
  - repo: https://github.com/PyCQA/pylint
    rev: v3.0.3
    hooks:
      - id: pylint
        name: Pylint code quality checks
        args: ['--disable=C0111,R0903,C0301,C0302,W0707,R1705,R0912,R0915,W0718,W0612,W0719,C0415,R0914,W1309,W0134,W0150,R1710,E0602,W0611,R0902,R0913,E0401,R1720']
        # Note: pylint-security requires Python 3.10+, disabled for Python 3.9 compatibility
        # args: ['--load-plugins=pylint_security', '--disable=C0111,R0903']
        # additional_dependencies: ['pylint-security']
        exclude: ^tests/

  # Local security tests
  - repo: local
    hooks:
      - id: security-regression-tests
        name: Security Regression Tests
        entry: python3 tests/test_security_regression.py
        language: system
        pass_filenames: false
        always_run: true

      - id: path-validation-tests
        name: Path Validation Tests
        entry: python3 tests/test_path_validation.py
        language: system
        pass_filenames: false
        always_run: true

      - id: string-sanitization-tests
        name: String Sanitization Tests
        entry: python3 tests/test_string_sanitization.py
        language: system
        pass_filenames: false
        always_run: true

      - id: cache-integrity-tests
        name: Cache Integrity Tests (HMAC)
        entry: python3 tests/test_cache_integrity.py
        language: system
        pass_filenames: false
        always_run: true

      - id: sqlite-security-tests
        name: SQLite Security Tests
        entry: python3 tests/test_sqlite_security.py
        language: system
        pass_filenames: false
        always_run: true

  # Semgrep custom security rules
  - repo: https://github.com/returntocorp/semgrep
    rev: v1.52.0
    hooks:
      - id: semgrep
        name: Semgrep Custom Security Scan
        args: ['--config=.semgrep.yml', 'vscode_scanner/', '--metrics=off', '--quiet']
        pass_filenames: false
        always_run: false  # Run manually: pre-commit run semgrep --all-files

  # Local version validation
  - repo: local
    hooks:
      - id: version-consistency
        name: Version Consistency Check
        entry: python3 scripts/bump_version.py --check
        language: system
        pass_filenames: false
        files: '(_version\.py|README\.md|CLAUDE\.md|PRD\.md)$'
