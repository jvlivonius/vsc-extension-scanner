# Pre-commit hooks for VS Code Extension Security Scanner
# Optimized configuration with fail-fast strategy and performance improvements
#
# Installation:
#   pip install pre-commit
#   pre-commit install
#
# Run manually:
#   pre-commit run --all-files
#
# Performance Optimizations (v3.5.7):
# - Consolidated 5 security test hooks into 1 (~8-10s savings)
# - Added file type filters (Python-only for scanners)
# - Reordered hooks for fail-fast strategy
# - Added dependency vulnerability scanning

repos:
  # ============================================================================
  # PHASE 1: Fast File Checks (~1 second)
  # Fail fast on obvious issues
  # ============================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
        name: Trim trailing whitespace
      - id: end-of-file-fixer
        name: Fix end of files
      - id: check-yaml
        name: Check YAML syntax
      - id: check-json
        name: Check JSON syntax
      - id: check-added-large-files
        name: Check for large files
        args: ['--maxkb=500']
      - id: check-merge-conflict
        name: Check for merge conflicts
      - id: detect-private-key
        name: Detect private keys
      - id: check-case-conflict
        name: Check for case conflicts
      - id: mixed-line-ending
        name: Check mixed line endings
        args: ['--fix=lf']

  # ============================================================================
  # PHASE 2: Code Formatting (~3 seconds)
  # Format before analysis so linters see formatted code
  # ============================================================================
  - repo: https://github.com/psf/black
    rev: 23.12.1
    hooks:
      - id: black
        name: Black code formatting
        language_version: python3
        args: ['--line-length=88']
        types: [python]  # OPTIMIZATION: Only run on Python files

  # ============================================================================
  # PHASE 3: Fast Security & Version Checks (~2 seconds)
  # ============================================================================
  - repo: local
    hooks:
      - id: version-consistency
        name: Version Consistency Check
        entry: python3 scripts/bump_version.py --check
        language: system
        pass_filenames: false
        files: '(_version\.py|README\.md|CLAUDE\.md|PRD\.md)$'

  # ============================================================================
  # PHASE 4: Static Security Analysis (~10 seconds)
  # High-value security checks with minimal false positives
  # ============================================================================
  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.6
    hooks:
      - id: bandit
        name: Bandit security scan
        args: ['-ll', '-r', 'vscode_scanner/']
        exclude: ^tests/
        types: [python]  # OPTIMIZATION: Only run on Python files

  - repo: https://github.com/returntocorp/semgrep
    rev: v1.52.0
    hooks:
      - id: semgrep
        name: Semgrep Custom Security Scan (11 rules, 0 ERROR FPs)
        args: ['--config=.semgrep.yml', 'vscode_scanner/', '--metrics=off', '--quiet']
        pass_filenames: false
        always_run: true
        types: [python]  # OPTIMIZATION: Only run on Python files

  # ============================================================================
  # PHASE 5: Code Quality (~12 seconds)
  # Slower checks, lower priority than security
  # ============================================================================
  - repo: https://github.com/PyCQA/pylint
    rev: v3.0.3
    hooks:
      - id: pylint
        name: Pylint code quality checks
        args: ['--disable=C0111,R0903,C0301,C0302,W0707,R1705,R0912,R0915,W0718,W0612,W0719,C0415,R0914,W1309,W0134,W0150,R1710,E0602,W0611,R0902,R0913,E0401,R1720,C0413,W0613']
        # Note: pylint-security requires Python 3.10+, disabled for Python 3.9 compatibility
        # TODO: Create .pylintrc file to move disabled rules out of args
        exclude: ^tests/
        types: [python]  # OPTIMIZATION: Only run on Python files

  # ============================================================================
  # PHASE 6: Dependency Security (~3 seconds, only on dependency changes)
  # NEW: Early detection of vulnerable dependencies
  # ============================================================================
  - repo: local
    hooks:
      - id: safety-check
        name: Safety - Dependency Vulnerability Scan
        entry: bash -c 'safety check --json || echo "⚠️  Dependency vulnerabilities detected - review in CI for details"'
        language: system
        pass_filenames: false
        files: 'requirements.*\.txt|pyproject\.toml|setup\.py'
        verbose: true

      - id: pip-audit-check
        name: pip-audit - PyPI Package Audit
        entry: bash -c 'pip-audit --desc || echo "⚠️  PyPI package issues detected - review in CI for details"'
        language: system
        pass_filenames: false
        files: 'requirements.*\.txt|pyproject\.toml|setup\.py'
        verbose: true

  # ============================================================================
  # PHASE 7: Security Test Suites (~27 seconds)
  # Slowest but highest confidence - consolidated for performance
  # OPTIMIZATION: Single invocation instead of 5 separate hooks (saves ~8-10s)
  # ============================================================================
  - repo: local
    hooks:
      - id: security-tests
        name: Security Test Suite (127 tests across 5 modules)
        entry: python3 scripts/run_tests.py --security-only --quiet
        language: system
        pass_filenames: false
        always_run: true
        # Replaces 5 separate hooks:
        # - security-regression-tests (24 tests)
        # - path-validation-tests (19 tests)
        # - string-sanitization-tests (22 tests)
        # - cache-integrity-tests (21 tests)
        # - sqlite-security-tests (8 tests)
